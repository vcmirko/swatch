---
- name: create destination volume and snapmirror
  hosts: "localhost"
  become: no
  gather_facts: no
  vars:
    source_svm: "{{ source.svm }}"
    source_volname: "{{ source.volname }}"
    cluster: "{{ destination.cluster }}"
    aggregate: "{{ destination.aggregate }}"
    svm: "{{ destination.svm }}"
    volname: "{{ destination.volname }}"
    junctionpath: "{{ '/'+volname }}"
    junctionpathqtree: "{{ junctionpath + '/' + volname }}"
    volsize: "{{ source.volsize|int | default(50) }}"
    clusterauth:  &login
      hostname: "{{ cluster }}"
      username: "{{ ontap_username }}"
      password: "{{ ontap_password}}"
      https: true
      validate_certs: false
  vars_files:
  #- volume_variables.yaml
  - ./globals.yml

  collections:
  - netapp.ontap
  tasks:
    - name: Create destination volume
      na_ontap_volume:
        state: present
        aggregate_name: "{{ aggregate }}"
        name: "{{ volname }}"
        vserver: "{{ svm }}"
        size: "{{ volsize|int }}"
        size_unit: mb
        wait_for_completion: yes
        type: dp
        <<: *login

    - name: Create snapmirror
      na_ontap_snapmirror:
        state: present
        source_volume: "{{source_volname}}"
        source_vserver: "{{source_svm}}"
        destination_volume : "{{volname}}"
        destination_vserver: "{{svm}}"
        <<: *login

    - name:  snapmirror
      na_ontap_snapmirror:
        state: present
        relationship_state: active
        source_volume: "{{source_volname}}"
        source_vserver: "{{source_svm}}"
        destination_volume : "{{volname}}"
        destination_vserver: "{{svm}}"
        <<: *login

    - name: Break snapmirror
      na_ontap_snapmirror:
        state: present
        relationship_state: broken
        source_volume: "{{source_volname}}"
        source_vserver: "{{source_svm}}"
        destination_volume : "{{volname}}"
        destination_vserver: "{{svm}}"
        <<: *login
      register: result
      retries: 5 # wait for initialized
      delay: 10 # wait 10 secs per try
      until: result is not failed

    - name: Mount volume
      na_ontap_volume:
        state: present
        name: "{{ volname }}"
        vserver: "{{ svm }}"
        junction_path: "{{ junctionpath }}"
        <<: *login

    - name: Create cifs
      na_ontap_cifs:
        state: present
        share_name: "{{ volname }}"
        vserver: "{{ svm }}"
        path: "{{ junctionpathqtree }}"
        <<: *login

    - name: Resync snapmirror
      na_ontap_snapmirror:
        state: present
        relationship_state: active
        source_volume: "{{source_volname}}"
        source_vserver: "{{source_svm}}"
        destination_volume : "{{volname}}"
        destination_vserver: "{{svm}}"
        <<: *login
